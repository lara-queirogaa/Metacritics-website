<?xml version="1.0" encoding="UTF-8"?><sqlb_project><db path="Metacritic.db" readonly="0" foreign_keys="1" case_sensitive_like="0" temp_store="0" wal_autocheckpoint="1000" synchronous="2"/><attached/><window><main_tabs open="structure browser query pragmas" current="2"/></window><tab_structure><column_width id="0" width="300"/><column_width id="1" width="0"/><column_width id="2" width="100"/><column_width id="3" width="1748"/><column_width id="4" width="0"/><expanded_item id="0" parent="1"/><expanded_item id="1" parent="1"/><expanded_item id="2" parent="1"/><expanded_item id="3" parent="1"/></tab_structure><tab_browse><table title="companies" custom_title="0" dock_id="2" table="4,9:maincompanies"/><dock_state state="000000ff00000000fd0000000100000002000002da00000322fc0100000002fb000000160064006f0063006b00420072006f00770073006500310100000000000002da0000000000000000fb000000160064006f0063006b00420072006f00770073006500320100000000000002da0000012300ffffff000002940000000000000004000000040000000800000008fc00000000"/><default_encoding codec=""/><browse_table_settings><table schema="main" name="companies" show_row_id="0" encoding="" plot_x_axis="" unlock_view_pk="_rowid_" freeze_columns="0"><sort/><column_widths><column index="1" value="87"/><column index="2" value="300"/></column_widths><filter_values/><conditional_formats/><row_id_formats/><display_formats/><hidden_columns/><plot_y_axes/><global_filter/></table></browse_table_settings></tab_browse><tab_sql><sql name="SQL 1*">WITH MetaPerDecade AS (
    SELECT 
        (CAST(substr(s.releaseDate,1,4) AS INTEGER)/10)*10 AS decade,
        g.genre_id,
        g.name AS genre,
        MAX(m.metascore) AS max_metascore,
        COUNT(*) AS film_count
    FROM shows s
    JOIN types t ON s.show_id = t.show_id
    JOIN genres g ON t.genre_id = g.genre_id
    JOIN metascore m ON s.show_id = m.show_id
    WHERE 
        releaseDate IS NOT NULL
        AND length(releaseDate) &gt;= 4       -- garante ano válido
        AND substr(releaseDate,1,4) GLOB '[0-9][0-9][0-9][0-9]'  -- só anos válidos
    GROUP BY decade, g.genre_id
),

Ranked AS (
    SELECT 
        decade,
        genre,
        max_metascore,
        film_count,
        ROW_NUMBER() OVER (
            PARTITION BY decade
            ORDER BY max_metascore DESC, film_count DESC, genre_id ASC
        ) AS rn
    FROM MetaPerDecade
)

SELECT decade, genre, max_metascore, film_count
FROM Ranked
WHERE rn = 1
ORDER BY decade;
</sql><current_tab id="0"/></tab_sql></sqlb_project>
